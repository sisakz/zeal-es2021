<html><!-- Mirrored from www.php.net/manual/en/function.openssl-pkcs7-sign.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 06:38:49 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>openssl_pkcs7_sign</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.openssl-pkcs7-sign.html">
 <link rel="shorturl" href="https://www.php.net/openssl-pkcs7-sign">
 <link rel="alternate" href="https://www.php.net/openssl-pkcs7-sign" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="ref.openssl.html">
 <link rel="prev" href="function.openssl-pkcs7-read.html">
 <link rel="next" href="function.openssl-pkcs7-verify.html">

 <link rel="alternate" href="function.openssl-pkcs7-sign.html" hreflang="en">
 <link rel="alternate" href="https://www.php.net/manual/pt_BR/function.openssl-pkcs7-sign.php" hreflang="pt_BR">
 <link rel="alternate" href="https://www.php.net/manual/zh/function.openssl-pkcs7-sign.php" hreflang="zh">
 <link rel="alternate" href="https://www.php.net/manual/fr/function.openssl-pkcs7-sign.php" hreflang="fr">
 <link rel="alternate" href="https://www.php.net/manual/de/function.openssl-pkcs7-sign.php" hreflang="de">
 <link rel="alternate" href="https://www.php.net/manual/ja/function.openssl-pkcs7-sign.php" hreflang="ja">
 <link rel="alternate" href="https://www.php.net/manual/ro/function.openssl-pkcs7-sign.php" hreflang="ro">
 <link rel="alternate" href="https://www.php.net/manual/ru/function.openssl-pkcs7-sign.php" hreflang="ru">
 <link rel="alternate" href="https://www.php.net/manual/es/function.openssl-pkcs7-sign.php" hreflang="es">
 <link rel="alternate" href="https://www.php.net/manual/tr/function.openssl-pkcs7-sign.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached0aba.css?t=1539771603&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached2ecf.css?t=1539765004&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedba57.css?t=1606338002&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached3afa.css?t=1627831203&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script>
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script src="https://www.php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>


</head>
<body class="docs " style="">


<div class="headsup"><a href="https://www.php.net/conferences/index.php#id2021-09-08-1">Longhorn PHP 2021</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.errors.html">Errors</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.attributes.html">Attributes</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.sessions.html">Session Security</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
	<dd><a href="refs.ui.html">GUI Extensions</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
    <div id="breadcrumbs-inner">
          
              
          <ul>
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.crypto.html">Cryptography Extensions</a></li>      <li><a href="book.openssl.html">OpenSSL</a></li>      <li><a href="ref.openssl.html">OpenSSL Functions</a></li>      </ul>
    </div>
  </div>




<div id="layout" class="clearfix">
  <section id="layout-content">
  <div id="function.openssl-pkcs7-sign" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_pkcs7_sign</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.6, PHP 5, PHP 7, PHP 8)</p><p class="refpurpose"><span class="refname">openssl_pkcs7_sign</span> â€” <span class="dc-title">Sign an S/MIME message</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.openssl-pkcs7-sign-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>openssl_pkcs7_sign</strong></span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$input_filename</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">string</span> <code class="parameter">$output_filename</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type"><a href="class.opensslcertificate.html" class="type OpenSSLCertificate">OpenSSLCertificate</a></span>|<span class="type">string</span></span> <code class="parameter">$certificate</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type"><span class="type"><a href="class.opensslasymmetrickey.html" class="type OpenSSLAsymmetricKey">OpenSSLAsymmetricKey</a></span>|<span class="type"><a href="class.opensslcertificate.html" class="type OpenSSLCertificate">OpenSSLCertificate</a></span>|<span class="type">array</span>|<span class="type">string</span></span> <code class="parameter">$private_key</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">array</span><span class="type"></span></span> <code class="parameter">$headers</code></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = <strong><code>PKCS7_DETACHED</code></strong></span></span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class="methodparam"><span class="type">?</span><span class="type"><span class="type">string</span><span class="type"></span></span> <code class="parameter">$untrusted_certificates_filename</code><span class="initializer"> = <strong><code>null</code></strong></span></span><br>): <span class="type">bool</span></div>

  <p class="para rdfs-comment">
   <span class="function"><strong>openssl_pkcs7_sign()</strong></span> takes the contents of the file
   named <code class="parameter">input_filename</code> and signs them using the
   certificate and its matching private key specified by
   <code class="parameter">certificate</code> and <code class="parameter">private_key</code>
   parameters.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-pkcs7-sign-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   </p><dl>
    
     <dt>
<code class="parameter">input_filename</code></dt>

     <dd>

      <p class="para">
        The input file you are intending to digitally sign.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">output_filename</code></dt>

     <dd>

      <p class="para">
        The file which the digital signature will be written to.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">certificate</code></dt>

     <dd>

      <p class="para">
        The X.509 certificate used to digitally sign <code class="parameter">input_filename</code>.
        See <a href="openssl.certparams.html" class="link">Key/Certificate parameters</a> for a list of valid values.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">private_key</code></dt>

     <dd>

      <p class="para">
        <code class="parameter">private_key</code> is the private key corresponding to <code class="parameter">certificate</code>.
        See <a href="openssl.certparams.html" class="link">Public/Private Key parameters</a> for a list of valid values.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">headers</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">headers</code> is an array of headers that
       will be prepended to the data after it has been signed (see
       <span class="function"><a href="function.openssl-pkcs7-encrypt.html" class="function">openssl_pkcs7_encrypt()</a></span> for more information about
       the format of this parameter).
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">flags</code> can be used to alter the output - see <a href="openssl.pkcs7.flags.html" class="link">PKCS7 constants</a>.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">untrusted_certificates_filename</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">untrusted_certificates_filename</code> specifies the name of a file containing
       a bunch of extra certificates to include in the signature which can for
       example be used to help the recipient to verify the certificate that you used.
      </p>
     </dd>

    
   </dl>

  <p></p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-pkcs7-sign-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <strong><code>true</code></strong> on success or <strong><code>false</code></strong> on failure.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.openssl-pkcs7-sign-changelog">
  <h3 class="title">Changelog</h3>
  <table class="doctable informaltable">
   
    <thead>
     <tr>
      <th>Version</th>
      <th>Description</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>8.0.0</td>
      <td>
       <code class="parameter">certificate</code> accepts an <span class="classname"><a href="class.opensslcertificate.html" class="classname">OpenSSLCertificate</a></span> instance now;
       previously, a <a href="language.types.resource.html" class="link">resource</a> of type <code class="literal">OpenSSL X.509 CSR</code> was accepted.
      </td>
     </tr>

     <tr>
      <td>8.0.0</td>
      <td>
       <code class="parameter">private_key</code> accepts an <span class="classname"><a href="class.opensslasymmetrickey.html" class="classname">OpenSSLAsymmetricKey</a></span>
       or <span class="classname"><a href="class.opensslcertificate.html" class="classname">OpenSSLCertificate</a></span> instance now;
       previously, a <a href="language.types.resource.html" class="link">resource</a> of type <code class="literal">OpenSSL key</code> or <code class="literal">OpenSSL X.509 CSR</code>
       was accepted.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 examples" id="refsect1-function.openssl-pkcs7-sign-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   </p><div class="example" id="example-898">
    <p><strong>Example #1 <span class="function"><strong>openssl_pkcs7_sign()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br></span><span style="color: #FF8000">//&nbsp;the&nbsp;message&nbsp;you&nbsp;want&nbsp;to&nbsp;sign&nbsp;so&nbsp;that&nbsp;recipient&nbsp;can&nbsp;be&nbsp;sure&nbsp;it&nbsp;was&nbsp;you&nbsp;that<br>//&nbsp;sent&nbsp;it<br></span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;&lt;&lt;&lt;EOD<br></span><span style="color: #DD0000"><br>You&nbsp;have&nbsp;my&nbsp;authorization&nbsp;to&nbsp;spend&nbsp;$10,000&nbsp;on&nbsp;dinner&nbsp;expenses.<br><br>The&nbsp;CEO<br></span><span style="color: #007700">EOD;<br></span><span style="color: #FF8000">//&nbsp;save&nbsp;message&nbsp;to&nbsp;file<br></span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br></span><span style="color: #FF8000">//&nbsp;encrypt&nbsp;it<br></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">openssl_pkcs7_sign</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"signed.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"file://mycert.pem"</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">"file://mycert.pem"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"mypassphrase"</span><span style="color: #007700">),<br>&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">"To"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"joes@example.com"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;keyed&nbsp;syntax<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"From:&nbsp;HQ&nbsp;&lt;ceo@example.com&gt;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;indexed&nbsp;syntax<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"Subject"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"Eyes&nbsp;only"</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;message&nbsp;signed&nbsp;-&nbsp;send&nbsp;it!<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">exec</span><span style="color: #007700">(</span><span style="color: #0000BB">ini_get</span><span style="color: #007700">(</span><span style="color: #DD0000">"sendmail_path"</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"&nbsp;&lt;&nbsp;signed.txt"</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  <p></p>
 </div>


</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="88645">  
  <a class="name">
  <strong class="user"><em>yurchenko dot anton at gmail dot com</em></strong></a><div class="date" title="2009-02-01 10:13"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom88645">
<div class="phpcode"><code><span class="html">
I also spent hours when trying to find the reason of error:
<br>"error getting private key". 
<br>
<br>Sometimes this error appeared, sometimes not. 
<br>
<br>My solution is using the realpath() for every parameter of openssl_pkcs7_sign. In my case the code looks like:
<br>
<br><span class="default">&lt;?php
<br>$Certif_path </span><span class="keyword">= </span><span class="string">'certificate/mycertificate.pem'</span><span class="keyword">;
<br>
<br></span><span class="default">$clearfile </span><span class="keyword">= </span><span class="string">"certificate/random_name"</span><span class="keyword">;
<br></span><span class="default">$encfile </span><span class="keyword">= </span><span class="default">$clearfile </span><span class="keyword">. </span><span class="string">".enc"</span><span class="keyword">;
<br></span><span class="default">$clearfile </span><span class="keyword">= </span><span class="default">$clearfile </span><span class="keyword">. </span><span class="string">".txt"</span><span class="keyword">;
<br>
<br></span><span class="comment">// ---- 
<br>// -- fill $clearfile with the mail to be signed ...
<br>// ----
<br>
<br></span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$clearfile</span><span class="keyword">), 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">realpath</span><span class="keyword">(</span><span class="string">'.'</span><span class="keyword">).</span><span class="string">'/'</span><span class="keyword">.</span><span class="default">$encfile</span><span class="keyword">, </span><span class="comment">// because $encfile does not exist yet we cannot use realpath($encfile);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'file://'</span><span class="keyword">.</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$Certif_path</span><span class="keyword">),
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file://'</span><span class="keyword">.</span><span class="default">realpath</span><span class="keyword">(</span><span class="default">$Certif_path</span><span class="keyword">), </span><span class="default">PUBLIC_KEY</span><span class="keyword">), 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="default">TO_EMAIL</span><span class="keyword">,
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="default">FROM_EMAIL</span><span class="keyword">,
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">""</span><span class="keyword">), 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">PKCS7_DETACHED</span><span class="keyword">));
<br>
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="121904">  
  <a class="name">
  <strong class="user"><em>jcmichot at usenet-fr dot net</em></strong></a><div class="date" title="2017-11-22 07:12"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom121904">
<div class="phpcode"><code><span class="html">
Due to lack of example the following code may be useful to some.<br><br># Demo code for openssl_pkcs7_sign() and openssl_pkcs7_encrypt() to sign and encrypt for Paypal EWP.<br>#<br># generate and self sign certificat<br># % openssl genrsa -out my-private-key.pem 2048<br># % openssl req -new -key my-private-key.pem -x509 -days 3650 -out my-public-key.pem<br>#<br><br>function demo_paypal_encrypt( $webform_hash )<br>{<br>&nbsp; &nbsp; $MY_PUBLIC_KEY = "file:///usr/local/etc/paypal/my-public-key.pem";<br>&nbsp; &nbsp; $MY_PRIVATE_KEY = "file:///usr/local/etc/paypal/my-private-key.pem";<br>&nbsp; &nbsp; $PAYPAL_PUBLIC_KEY = "file:///usr/local/etc/paypal/paypal_cert_pem.txt";<br><br>&nbsp; &nbsp; //Assign Build Notation for PayPal Support<br>&nbsp; &nbsp; $webform_hash['bn']= 'MyWebRef.PHP_EWP2';<br><br>&nbsp; &nbsp; $data = "";<br>&nbsp; &nbsp; foreach ($webform_hash as $key =&gt; $value)<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($value != "")<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $data .= "$key=$value\n";<br><br>&nbsp; &nbsp; $file_msg = sprintf( "/tmp/pp-msg-%d.txt", getmypid() );<br>&nbsp; &nbsp; $file_sign = sprintf( "/tmp/pp-sign-%d.mpem", getmypid() );<br>&nbsp; &nbsp; $file_bsign = sprintf( "/tmp/pp-sign-%d.der", getmypid() );<br>&nbsp; &nbsp; $file_enc = sprintf( "/tmp/pp-enc-%d.txt", getmypid() );<br><br>&nbsp; &nbsp; if ( file_exists( $file_msg ) ) unlink( $file_msg );<br>&nbsp; &nbsp; if ( file_exists( $file_sign ) ) unlink( $file_sign );<br>&nbsp; &nbsp; if ( file_exists( $file_bsign ) ) unlink( $file_bsign );<br>&nbsp; &nbsp; if ( file_exists( $file_enc ) ) unlink( $file_enc );<br><br>&nbsp; &nbsp; $fp = fopen( $file_msg, "w" );<br>&nbsp; &nbsp; if ( $fp ) {<br>&nbsp; &nbsp; &nbsp; &nbsp; fwrite($fp, $data );<br>&nbsp; &nbsp; &nbsp; &nbsp; fclose($fp);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; // sign part of html form message<br>&nbsp; &nbsp; openssl_pkcs7_sign(<br>&nbsp; &nbsp; &nbsp; &nbsp; $file_msg,<br>&nbsp; &nbsp; &nbsp; &nbsp; $file_sign,<br>&nbsp; &nbsp; &nbsp; &nbsp; $MY_PUBLIC_KEY,<br>&nbsp; &nbsp; &nbsp; &nbsp; array( $MY_PRIVATE_KEY, "" ), /// private key, password<br>&nbsp; &nbsp; &nbsp; &nbsp; array(),<br>&nbsp; &nbsp; &nbsp; &nbsp; PKCS7_BINARY<br>&nbsp; &nbsp; &nbsp; &nbsp; );<br><br>&nbsp; &nbsp; // convert PEM to DER<br>&nbsp; &nbsp; $pem_data = file_get_contents( $file_sign );<br>&nbsp; &nbsp; $begin = "Content-Transfer-Encoding: base64";<br>&nbsp; &nbsp; $pem_data = trim( substr($pem_data, strpos($pem_data, $begin)+strlen($begin)) );<br>&nbsp; &nbsp; $der = base64_decode( $pem_data );<br><br>&nbsp; &nbsp; $fp = fopen( $file_bsign, "w" );<br>&nbsp; &nbsp; if ( $fp ) {<br>&nbsp; &nbsp; &nbsp; &nbsp; fwrite($fp, $der );<br>&nbsp; &nbsp; &nbsp; &nbsp; fclose($fp);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; // you could verify correct DER signature by:<br>&nbsp; &nbsp; // % openssl smime -verify -CAfile $MY_PUBLIC_KEY -inform DER -in $file_bsign<br><br>&nbsp; &nbsp; //encrypt the message, with Paypal public key<br>&nbsp; &nbsp; openssl_pkcs7_encrypt(<br>&nbsp; &nbsp; &nbsp; &nbsp; $file_bsign,<br>&nbsp; &nbsp; &nbsp; &nbsp; $file_enc,<br>&nbsp; &nbsp; &nbsp; &nbsp; $PAYPAL_PUBLIC_KEY,<br>&nbsp; &nbsp; &nbsp; &nbsp; array(),<br>&nbsp; &nbsp; &nbsp; &nbsp; PKCS7_BINARY,<br>&nbsp; &nbsp; &nbsp; &nbsp; OPENSSL_CIPHER_3DES&nbsp; );<br><br>&nbsp; &nbsp; $data = file_get_contents( $file_enc );<br>&nbsp; &nbsp; $data = substr($data, strpos($data, $begin)+strlen($begin));<br>&nbsp; &nbsp; $data = "-----BEGIN PKCS7-----\n".&nbsp; trim( $data ) . "\n-----END PKCS7-----";<br><br>&nbsp; &nbsp; // cleanup<br>&nbsp; &nbsp; if ( file_exists( $file_msg ) ) unlink( $file_msg );<br>&nbsp; &nbsp; if ( file_exists( $file_sign ) ) unlink( $file_sign );<br>&nbsp; &nbsp; if ( file_exists( $file_bsign ) ) unlink( $file_bsign );<br>&nbsp; &nbsp; if ( file_exists( $file_enc ) ) unlink( $file_enc );<br><br>&nbsp; &nbsp; return( $data );<br>}</span>
</code></div>
  </div>
 </div>
  <div class="note" id="36653">  
  <a class="name">
  <strong class="user"><em>Maciej_Niemir at ilim dot poznan dot pl</em></strong></a><div class="date" title="2003-10-17 07:46"><strong>17 years ago</strong></div>
  <div class="text" id="Hcom36653">
<div class="phpcode"><code><span class="html">
This command doesn't work correctly on WIN32 with IIS. Mails aren\x92t interpreted correctly by IIS SMTP Server (and by Outlook too). The reason is that UNIX and WINDOWS interpret the \x93enter to the next line\x94 ascii code in a different way.
<br>
<br>Below I present an improved code:
<br>
<br><span class="default">&lt;?php
<br>
<br>$data </span><span class="keyword">= &lt;&lt;&lt;EOD
<br></span><span class="string">
<br>Testing 123
<br>
<br>This is a test
<br>
<br>Test
<br>
<br></span><span class="keyword">EOD;
<br>
<br></span><span class="comment">//save the message to a file
<br></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">);
<br></span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br>
<br></span><span class="comment">//sign the message using the sender's keys
<br></span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"signed.eml"</span><span class="keyword">, </span><span class="string">"file://c:/max/cert.pem"</span><span class="keyword">,
<br>array(</span><span class="string">"file://c:/max/priv.pem"</span><span class="keyword">,</span><span class="string">"your_password"</span><span class="keyword">),
<br>array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"recipient &lt;recipients@mail.com&gt;"</span><span class="keyword">,
<br></span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"sender &lt;sender@mail.com&gt;"</span><span class="keyword">,
<br></span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Order Notification - Test"</span><span class="keyword">),</span><span class="default">PKCS7_DETACHED</span><span class="keyword">,</span><span class="string">"c:\max\extra_cert.pem"</span><span class="keyword">);
<br>
<br></span><span class="default">$file_arry </span><span class="keyword">= </span><span class="default">file</span><span class="keyword">(</span><span class="string">"signed.eml"</span><span class="keyword">);
<br></span><span class="default">$file </span><span class="keyword">= </span><span class="default">join </span><span class="keyword">(</span><span class="string">""</span><span class="keyword">, </span><span class="default">$file_arry</span><span class="keyword">);
<br></span><span class="default">$message </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\r\n|\r|\n/"</span><span class="keyword">, </span><span class="string">"\r\n"</span><span class="keyword">, </span><span class="default">$file</span><span class="keyword">);
<br>
<br></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"c:\Inetpub\mailroot\Pickup\signed.eml"</span><span class="keyword">, </span><span class="string">"wb"</span><span class="keyword">);
<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);
<br></span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br>
<br></span><span class="default">?&gt;
<br></span>
<br>Besides, if you want to use the keys created with Windows, you should export them (from IE) to the form of PKCS#12 file (*.pfx).
<br>
<br>Install OpenSSLWin32 from
<br><a rel="nofollow" target="_blank">http://www.shininglightpro.com/search.php?searchname=Win32+OpenSSL</a>
<br>
<br>execute: openssl.exe
<br>
<br>enter the commands:
<br>
<br>pkcs12 -in &lt;pfx-file&gt; -nokeys -out &lt;pem-certs-file&gt;
<br>
<br>pkcs12 -in &lt;pfx-file&gt; -nocerts -nodes -out &lt;pem-key-file&gt;
<br>
<br>Next export from IE Root CA certificate as Base-64 *.cer and rename the file to *.pem
<br>
<br>And that's all!</span>
</code></div>
  </div>
 </div>
  <div class="note" id="96155">  
  <a class="name">
  <strong class="user"><em>ungdi at hotmail dot com</em></strong></a><div class="date" title="2010-02-11 05:34"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom96155">
<div class="phpcode"><code><span class="html">
Amongst the many discussions about signing or encrypting email by itself, none really discuss the pain of having an email BOTH signed AND encrypted.<br><br>According to RFC 2311, you can encrypt then sign or sign then encrypt. However, it depends on the client in which you are programming for. In my experience, in Outlook 2000, it prefers it Encrypt then Sign. While in Outlook 2003, it is Sign then Encrypt. Generally, you want Sign then Encrypt, as it seems most logical from a snail-mail piece point of view. You first sign a letter than put it in an envelope. Certain clients complain if you do it in an order it does not like, so you may want to experiement with it.<br><br>When you perform the first function, do NOT put in any headers in the headers array parameters, you want to put it in the SECOND function you want to perform. If you put the headers in the first function, the second function will hide it from the mail servers. You do not want that. Here I will sign then encrypt.<br><br><span class="default">&lt;?php<br></span><span class="comment">// Setup mail headers.<br></span><span class="default">$headers </span><span class="keyword">= array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"someone@nowhere.net"</span><span class="keyword">,<br>&nbsp; &nbsp;&nbsp; </span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"noone@somewhere.net"</span><span class="keyword">,<br>&nbsp; &nbsp;&nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"A signed and encrypted message."</span><span class="keyword">);<br><br></span><span class="comment">// Sign the message first<br></span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">,</span><span class="string">"signed.txt"</span><span class="keyword">,<br>&nbsp; &nbsp;&nbsp; </span><span class="string">"signing_cert.pem"</span><span class="keyword">,array(</span><span class="string">"private_key.pem"</span><span class="keyword">,<br>&nbsp; &nbsp;&nbsp; </span><span class="string">"password"</span><span class="keyword">),array());<br><br></span><span class="comment">// Get the public key certificate.<br></span><span class="default">$pubkey </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"cert.pem"</span><span class="keyword">);<br><br></span><span class="comment">//encrypt the message, now put in the headers.<br></span><span class="default">openssl_pkcs7_encrypt</span><span class="keyword">(</span><span class="string">"signed.txt"</span><span class="keyword">, </span><span class="string">"enc.txt"</span><span class="keyword">,<br>&nbsp; &nbsp;&nbsp; </span><span class="default">$pubkey</span><span class="keyword">,</span><span class="default">$headers</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br><br></span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"enc.txt"</span><span class="keyword">);<br><br></span><span class="comment">// separate header and body, to use with mail function<br>//&nbsp; unfortunate but required, else we have two sets of headers<br>//&nbsp; and the email client doesn't decode the attachment<br></span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br><br></span><span class="comment">// send mail (headers in the Headers parameter will override those<br>//&nbsp; generated for the To &amp; Subject parameters)<br></span><span class="default">mail</span><span class="keyword">(</span><span class="default">$mail</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br></span><span class="default">?&gt;<br></span><br>Note that if you use a function that picks up the data from the disk to be used in another function in your program, remember that you may have used the explode("\n\n",$data,2) function which may have removed the spacing between the header and the message content.<br><br>When you take the signed message and feed it in to the encryption part, you have to remember that the line spacing must also be fed AS PART OF THE MESSAGE BODY! If you plan to sign then encrypt, do not feed the header output from the signing into the encrypting as part of the headers array parameter! The output of the signing should stay as part of the message body being encrypted. (And the same is true if you are doing the reverse of encrypting then signing.) An example of both the signing and encryption function made in to a routine for reusability, and then called to sign and encrypt a message.<br><br>THIS IS WRONG!:<br><span class="default">&lt;?php<br></span><span class="comment">// [0] of Array contains headers of message. [1] of Array contains signed body of message.<br></span><span class="default">$signedOutputArray </span><span class="keyword">= </span><span class="default">signMessage</span><span class="keyword">(</span><span class="default">$inputMessage</span><span class="keyword">,</span><span class="default">$headers</span><span class="keyword">);<br><br></span><span class="comment">// [0] of Array contains headers of message and the signing.<br>// [1] of Array contains encrypted body of message without the signing header.<br></span><span class="default">$signedAndEncryptedArray </span><span class="keyword">= </span><span class="default">encryptMessage</span><span class="keyword">(</span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br>&nbsp; &nbsp;&nbsp; </span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br><br></span><span class="default">mail</span><span class="keyword">(</span><span class="default">$emailAddr</span><span class="keyword">,</span><span class="default">$subject</span><span class="keyword">,</span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br>&nbsp; &nbsp; &nbsp; </span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br></span><span class="default">?&gt;<br></span><br>THIS IS CORRECT!<br><span class="default">&lt;?php<br></span><span class="comment">// [0] of Array contains headers of signing.<br>// [1] of Array contains signed body of message.<br></span><span class="default">$signedOutputArray </span><span class="keyword">= </span><span class="default">signMessage</span><span class="keyword">(</span><span class="default">$inputMessage</span><span class="keyword">,array());<br><br></span><span class="comment">// [0] of Array contains headers of message.<br>// [1] of Array contains encrypted contents of both the signed message and its headers of the signing.<br></span><span class="default">$signedAndEncryptedArray </span><span class="keyword">=<br>&nbsp; &nbsp;&nbsp; </span><span class="default">encryptMessage</span><span class="keyword">(</span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] . </span><span class="string">"\n\n" </span><span class="keyword">. </span><span class="default">$signedOutputArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">$headers</span><span class="keyword">);<br><br></span><span class="default">mail</span><span class="keyword">(</span><span class="default">$emailAddr</span><span class="keyword">,</span><span class="default">$subject</span><span class="keyword">,</span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],<br>&nbsp; &nbsp;&nbsp; </span><span class="default">$signedAndEncryptedArray</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="111336">  
  <a class="name">
  <strong class="user"><em>Anonymous</em></strong></a><div class="date" title="2013-02-08 04:35"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom111336">
<div class="phpcode"><code><span class="html">
A note about the $flags parameter: PKCS7_BINARY has 2 effects:<br>* converts LF to CR+LF, as described in <a rel="nofollow" target="_blank">http://www.php.net/manual/en/openssl.pkcs7.flags.php</a><br>* it creates an opaque pkcs7 signature (p7m)<br><br>If you want to prevent the LF-&gt;CR+LF conversion *and* still have a detached signature (p7s), use PKCS7_BINARY | PKCS7_DETACHED (both flags are set).<br><br>If the signed message is already MIME multi-part, using both flags as described above seems to be the right solution to assemble the message properly. Without any flags, apparently only some of the LF characters are converted. In a specific scenario (the local MTA is Postfix and then the message goes through sendmail on another machine), the MIME boundaries get scrambled in sendmail. However, this doesn't seem to happen if the local MTA is sendmail.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="124271">  
  <a class="name">
  <strong class="user"><em>spam at isag dot melbourne</em></strong></a><div class="date" title="2019-10-08 12:23"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom124271">
<div class="phpcode"><code><span class="html">
If you want to use mail() with headers, then you'll need to alter the signed version before embedding in the body or the headers and boundaries will end up in the message.<br><br><span class="default">&lt;?php<br>openssl_pkcs7_sign</span><span class="keyword">(</span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'email.txt'</span><span class="keyword">, </span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'signed.txt'</span><span class="keyword">, </span><span class="string">'file://' </span><span class="keyword">. </span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'cert.pem'</span><span class="keyword">, array(</span><span class="string">'file://' </span><span class="keyword">. </span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'key.pem'</span><span class="keyword">, </span><span class="default">$keypass</span><span class="keyword">), array(</span><span class="string">'To' </span><span class="keyword">=&gt; </span><span class="default">$smime_to</span><span class="keyword">, </span><span class="string">'From' </span><span class="keyword">=&gt; </span><span class="default">$smime_from</span><span class="keyword">, </span><span class="string">'Subject' </span><span class="keyword">=&gt; </span><span class="default">$smime_subject</span><span class="keyword">));<br>if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/To: [^\r\n]+(\r|\n)+(From: [^\r\n]+(\r|\n)+)Subject: [^\r\n]+(\r|\n)+MIME-Version: [^\r\n]+(\r|\n)+(Content-Type: [^\r\n]+)(\r|\n)+/'</span><span class="keyword">, </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'signed.txt'</span><span class="keyword">), </span><span class="default">$matches</span><span class="keyword">))<br>{<br>&nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">mail</span><span class="keyword">(</span><span class="default">$smime_to</span><span class="keyword">, </span><span class="default">$smime_subject</span><span class="keyword">, </span><span class="default">str_replace</span><span class="keyword">(</span><span class="default">$matches</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">''</span><span class="keyword">, </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$basedir </span><span class="keyword">. </span><span class="string">'signed.txt'</span><span class="keyword">)), </span><span class="default">$mailheaders </span><span class="keyword">. </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] . </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">6</span><span class="keyword">]);<br>}<br></span><span class="default">?&gt;<br></span><br>With the signed headers removed ($matches[0]) and the headers updated with From (not part of mail()) and Content-Type ($matches[2] / $matches[6] respectively).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="73139">  
  <a class="name">
  <strong class="user"><em>ungdi at hotmail dot com</em></strong></a><div class="date" title="2007-02-10 01:10"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom73139">
<div class="phpcode"><code><span class="html">
I would like to make a modification from my previous note. Some clients prefer a certain order in which messages should be signed and encrypted (if both is desired). Newer email clients, such as Thunderbird and Outlook 2003 will accept the most secure method of "sign -&gt; encrypt -&gt; sign again".<br><br>Why?<br><br>The first signing authenticates the message saying that you did indeed write it. Then the email is encrypted so that only the recipient can open and read it. Then the second signing ensure confidentiality by identifying that the person encrypting is the one whom encrypted it, a message intended for the decrypting person. This is the most secure method. This ensures: Non-Repudiation of message (first sign), Confidentiality (encrypt), and Context Integrity [you were intended to be addressed] (second sign).<br><br>If you only sign then encrypt, there is no way you can guarantee that (aside from the contents of the letter, headers are placed in plain text outside the message) that the message was intended for you by the original sender. For example:<br><br>Bob signs a love letter and encrypts it to Amy saying only "I love you. -- Bob". Amy decrypts it, sees the message (and plays a joke) and forwards the message to John using John's public key, re-encrypting, but not tampering with the message contents keeping the signature valid. This allows Amy to make it look like Bob sent John a love letter and that Bob loves John, as you cannot verify whom sent it during encryption. That is not what you want!<br><br>This is also analogous to someone taking a government document, put it in an envelope themselves and write the government address in the return address and send it to you. You know the letter is written by the government, but you don't know for sure whether the government sent it to you directly or was opened and relayed.<br><br>While encrypting then signing has a problem, this is affectively signing on the envelope of a snail mail piece. I know you sent it, but is the message really from you? Or are you forwarding it?<br><br>Sign - Encrypt - Sign Again method will make the first sign show that you know the writer of the message is the person, encrypt it to keep others from reading it, sign again to indicate the message was not relayed and that the sender intended to sent the mail to address you.<br><br>Just make sure the headers of the mail is applied in the last step and not the second or third step.<br><br>For more information about the security and integrity risks of this situation, please read this web page: <a rel="nofollow" target="_blank">http://world.std.com/~dtd/sign_encrypt/sign_encrypt7.html</a></span>
</code></div>
  </div>
 </div>
  <div class="note" id="49892">  
  <a class="name">
  <strong class="user"><em>maarten at xolphin dot nl</em></strong></a><div class="date" title="2005-02-11 02:24"><strong>16 years ago</strong></div>
  <div class="text" id="Hcom49892">
<div class="phpcode"><code><span class="html">
It is also possible to sign message including attachments. An easy way to do this:
<br>
<br><span class="default">&lt;?php
<br>&nbsp; $boundary </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">uniqid</span><span class="keyword">(</span><span class="default">time</span><span class="keyword">()));
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">= </span><span class="string">"MIME-Version: 1.0\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: multipart/mixed; boundary=\"" </span><span class="keyword">. </span><span class="default">$boundary</span><span class="keyword">. </span><span class="string">"\"\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: quoted-printable\n\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"This is a multi-part message in MIME format.\n\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: text/plain; charset=\"iso-8859-1\"\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: quoted-printable\n\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="default">$EmailText </span><span class="keyword">. </span><span class="string">"\n\n"</span><span class="keyword">;
<br>&nbsp; </span><span class="comment">// Add the attachment to the message
<br>&nbsp; </span><span class="keyword">do&nbsp; {
<br>&nbsp; &nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Type: application/pdf; name=\"FileName\"\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: base64\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"Content-Disposition: attachment;\n\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="default">chunk_split</span><span class="keyword">(</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) . </span><span class="string">"\n\n"</span><span class="keyword">;
<br>&nbsp; } while ( {</span><span class="default">files left to be attached</span><span class="keyword">} );
<br>&nbsp; </span><span class="default">$boddy </span><span class="keyword">.= </span><span class="string">"--</span><span class="default">$boundary</span><span class="string">--\n"</span><span class="keyword">;
<br>
<br>&nbsp; </span><span class="comment">// Save message to a file
<br>&nbsp; </span><span class="default">$msg </span><span class="keyword">= </span><span class="string">'msg.txt'</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$signed </span><span class="keyword">= </span><span class="string">'signed.txt'</span><span class="keyword">;
<br>&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br>&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$boddy</span><span class="keyword">);
<br>&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br>
<br>&nbsp; </span><span class="comment">// Sign it
<br>&nbsp; </span><span class="keyword">if (</span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$signed</span><span class="keyword">, </span><span class="string">'file://cert.pem'</span><span class="keyword">,
<br>&nbsp; &nbsp; array(</span><span class="string">'file://key.pem'</span><span class="keyword">, </span><span class="string">'test'</span><span class="keyword">),
<br>&nbsp; &nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"joes@example.com"</span><span class="keyword">, </span><span class="comment">// keyed syntax
<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"From: HQ &lt;ceo@example.com&gt;"</span><span class="keyword">, </span><span class="comment">// indexed syntax
<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Eyes only"</span><span class="keyword">), </span><span class="default">PKCS7_DETACHED</span><span class="keyword">, </span><span class="string">'intermediate_cert.pem' </span><span class="keyword">)) {&nbsp; 
<br>&nbsp; &nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">'sendmail_path'</span><span class="keyword">) . </span><span class="string">' &lt; ' </span><span class="keyword">. </span><span class="default">$signed</span><span class="keyword">);
<br>&nbsp; }
<br></span><span class="default">?&gt;
<br></span>
<br>The same can be established by using the PEAR package Mail_Mime in combination with openssl_pkcs7_sign.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="36038">  
  <a class="name">
  <strong class="user"><em>php at toyingwithfate dot com</em></strong></a><div class="date" title="2003-09-23 02:55"><strong>17 years ago</strong></div>
  <div class="text" id="Hcom36038">
<div class="phpcode"><code><span class="html">
It's probably worth noting that I had a great deal of difficulty getting either Mozilla 1.4 or Outlook Express 6 to verify signatures generated by openssl_pkcs7_sign() until I added a newline (\n) to the beginning of the message I was signing.&nbsp; Not sure why that is, but as soon as I made that change all problems disappeared.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="21212">  
  <a class="name">
  <strong class="user"><em>del at babel dot com dot au</em></strong></a><div class="date" title="2002-05-03 03:09"><strong>19 years ago</strong></div>
  <div class="text" id="Hcom21212">
<div class="phpcode"><code><span class="html">
The "mycert.pem" parameters as shown in the example above are not correct.&nbsp; You either have to pass a string containing the PEM encoded certificate or key, or the location of a file in file://path/to/file.pem notation.&nbsp; See the comments on the OpenSSL functions page (the page above this one).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="15290">  
  <a class="name">
  <strong class="user"><em>meint dot post at bigfoot dot com</em></strong></a><div class="date" title="2001-09-04 04:35"><strong>20 years ago</strong></div>
  <div class="text" id="Hcom15290">
<div class="phpcode"><code><span class="html">
If you want to integrate PKCS7 signing/verifying with a browser and it's not a problem that it's only Internet Explorer (or Netscape + ActiveX plugin) you can look at Capicom. It's a free component and available at the MSDN website.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="63971">  
  <a class="name">
  <strong class="user"><em>dmitri at gmx dot net</em></strong></a><div class="date" title="2006-04-04 01:01"><strong>15 years ago</strong></div>
  <div class="text" id="Hcom63971">
<div class="phpcode"><code><span class="html">
Working example:<br><br><span class="default">&lt;?php<br><br>$data </span><span class="keyword">= &lt;&lt;&lt; EOF<br></span><span class="string">Content-Type: text/plain;<br>&nbsp; &nbsp; charset="us-ascii"<br>Content-Transfer-Encoding: 7bit<br><br>You have my authorization to spend 10,000 on dinner expenses.<br>The CEO<br></span><span class="keyword">EOF;<br><br></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br></span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br><br></span><span class="default">$headers </span><span class="keyword">= array(</span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"me@email.com"</span><span class="keyword">);<br><br></span><span class="default">openssl_pkcs7_sign</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"signed.txt"</span><span class="keyword">, </span><span class="string">"file://email.pem"</span><span class="keyword">, array(</span><span class="string">"file://email.pem"</span><span class="keyword">, </span><span class="string">"123456"</span><span class="keyword">), </span><span class="default">$headers</span><span class="keyword">);<br><br></span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"signed.txt"</span><span class="keyword">);<br><br></span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br><br></span><span class="default">mail</span><span class="keyword">(</span><span class="string">"you@email.com"</span><span class="keyword">, </span><span class="string">"Signed message."</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br><br>echo </span><span class="string">"Email sent"</span><span class="keyword">;<br><br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->

  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from www.php.net/manual/en/function.openssl-pkcs7-sign.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 06:38:49 GMT -->

</body></html>