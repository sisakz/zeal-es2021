<html><!-- Mirrored from www.php.net/manual/en/oci8.taf.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 07:25:31 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>OCI8 Transparent Application Failover (TAF) Support</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="oci8.taf.html">
 <link rel="shorturl" href="oci8.taf.html">
 <link rel="alternate" href="oci8.taf.html" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="book.oci8.html">
 <link rel="prev" href="oci8.fan.html">
 <link rel="next" href="oci8.dtrace.html">

 <link rel="alternate" href="oci8.taf.html" hreflang="en">
 <link rel="alternate" href="https://www.php.net/manual/pt_BR/oci8.taf.php" hreflang="pt_BR">
 <link rel="alternate" href="https://www.php.net/manual/zh/oci8.taf.php" hreflang="zh">
 <link rel="alternate" href="https://www.php.net/manual/fr/oci8.taf.php" hreflang="fr">
 <link rel="alternate" href="https://www.php.net/manual/de/oci8.taf.php" hreflang="de">
 <link rel="alternate" href="https://www.php.net/manual/ja/oci8.taf.php" hreflang="ja">
 <link rel="alternate" href="https://www.php.net/manual/ro/oci8.taf.php" hreflang="ro">
 <link rel="alternate" href="https://www.php.net/manual/ru/oci8.taf.php" hreflang="ru">
 <link rel="alternate" href="https://www.php.net/manual/es/oci8.taf.php" hreflang="es">
 <link rel="alternate" href="https://www.php.net/manual/tr/oci8.taf.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached0aba.css?t=1539771603&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached2ecf.css?t=1539765004&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedba57.css?t=1606338002&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached3afa.css?t=1627831203&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script>
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script src="https://www.php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>


</head>
<body class="docs " style="">


<div class="headsup"><a href="https://www.php.net/conferences/index.php#id2021-09-08-1">Longhorn PHP 2021</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.errors.html">Errors</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.attributes.html">Attributes</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.sessions.html">Session Security</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
	<dd><a href="refs.ui.html">GUI Extensions</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
    <div id="breadcrumbs-inner">
          
              
          <ul>
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.database.html">Database Extensions</a></li>      <li><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>      <li><a href="book.oci8.html">OCI8</a></li>      </ul>
    </div>
  </div>




<div id="layout" class="clearfix">
  <section id="layout-content">
  <div id="oci8.taf" class="chapter">
 <h1>OCI8 Transparent Application Failover (TAF) Support</h1>

 <div class="section">
  <p class="para">
   TAF is an Oracle Database feature that provides high availability.
   It enables PHP OCI8 applications to automatically reconnect to a
   preconfigured database when database connectivity fails due to
   instance or network failure.
  </p>
  <p class="para">
   In a configured Oracle Database system, TAF occurs when the PHP
   application detects that the database instance is down or
   unreachable. It establishes a connection to another node in an
   Oracle <a href="https://www.oracle.com/pls/topic/lookup?ctx=dblatest&amp;id=GUID-DEF850F6-27E9-428E-B8FC-530230D78AD2" class="link external">»&nbsp;RAC</a>
   configuration, a hot standby database, or the same database
   instance
   itself. See <a href="https://www.oracle.com/pls/topic/lookup?ctx=dblatest&amp;id=GUID-F7817CD2-4A2C-4D37-BD36-56DBABD4725F" class="link external">»&nbsp;Oracle
   Call Interface Programmer's Guide</a> for more information about
   OCI TAF.
  </p>
  <p class="para">
   An application callback can be registered
   with <span class="function"><a href="function.oci-register-taf-callback.html" class="function">oci_register_taf_callback()</a></span>. During
   failover, normal application processing stops and the registered
   callback is invoked.  The callback notifies the application of the
   failover events. If the failover succeeds, normal processing will
   be resumed. If the failover aborts, any following database
   operations in the application will fail due to no connection being
   available.
  </p>
  <p class="para">
   When a connection fails over to another database, the callback can
   reset any necessary connection state, for example replaying any
   necessary ALTER SESSION commands if the database service did not have
   -failover_restore enabled.
  </p>
  <p class="para">
   An application callback can be removed by calling <span class="function"><a href="function.oci-unregister-taf-callback.html" class="function">oci_unregister_taf_callback()</a></span>.
  </p>
 </div>
 <div class="section">
  <h2 class="title">Configuring Transparent Application Failover</h2>
  <p class="para">
   TAF can be configured on the PHP OCI8 side or in the database
   configuration. If both are configured, database-side settings
   take precedence.
  </p>
  <p class="para">
   Configure TAF in PHP OCI8 (the client side) by including the
   FAILOVER_MODE parameter in the CONNECT_DATA portion of a
   connect descriptor. See Configuring Transparent Application
   Failover in <a href="https://www.oracle.com/pls/topic/lookup?ctx=dblatest&amp;id=GUID-8F532535-C401-4B51-BE0B-04FD74BB0621" class="link external">»&nbsp;
   Oracle Database Net Services Administrator's Guide</a> for
   more information about client side configuration of TAF.
  </p>
  <p class="para">
   An example tnsnames.ora to configure TAF reconnecting to the
   same database instance:
  </p>
  <p class="para">
    </p><div class="informalexample">
     <div class="example-contents screen">
<div class="cdata"><pre>    ORCL =
      (DESCRIPTION =
        (ADDRESS = (PROTOCOL = TCP)(HOST = 127.0.0.1)(PORT = 1521))
        (CONNECT_DATA =
          (SERVICE_NAME = orclpdb1)
          (FAILOVER_MODE =
            (TYPE = SELECT)
            (METHOD = BASIC)
            (RETRIES = 20)
            (DELAY = 15))))
 </pre></div>
     </div>
   </div>
  <p></p>
  <p class="para">
   Alternatively configure TAF on the database side by
   modifying the target service with
   <a href="https://www.oracle.com/pls/topic/lookup?ctx=dblatest&amp;id=GUID-8DC4D5E0-CA9D-47BC-BAD0-8769405AFEC5" class="link external">»&nbsp;srvctl</a>
   (for RAC) or the
   <a href="https://www.oracle.com/pls/topic/lookup?ctx=dblatest&amp;id=GUID-C11449DC-EEDE-4BB8-9D2C-0A45198C1928" class="link external">»&nbsp;
   DBMS_SERVICE.MODIFY_SERVICE</a> packaged procedure
   (for single instance databases).
  </p>
 </div>
 <div class="section">
  <h2 class="title">Using TAF Callbacks in OCI8</h2>
  <p class="para">
   A TAF callback is an application function that can be
   registered to be called during failover. It is called
   several times while re-establishing the application's connection.
  </p>
  <p class="para">
   Callback first occurs when a loss of connection is detected.
   This allows the application to act accordingly for the
   upcoming delay of the failover. If the failover is successful,
   the callback is invoked after connection is re-established
   and usable. At this time, the application can resynchronize
   session settings and take actions such as informing the user
   that failover occurred. If failover is unsuccessful, a
   callback occurs to inform the application that a failover did
   not take place and the connection is unusable.
  </p>
  <p class="para">
   The interface of a TAF user-defined callback function is as
   follows:
  </p>
  <div class="methodsynopsis dc-description">
   <span class="methodname"><strong>userCallbackFn</strong></span>(<span class="methodparam"><span class="type">resource</span> <code class="parameter">$connection</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$event</code></span>, <span class="methodparam"><span class="type">int</span> <code class="parameter">$type</code></span>): <span class="type">int</span></div>

  <p class="para">
   </p><dl>
    
     <dt>
<code class="parameter">connection</code></dt>

     <dd>

      <p class="para">
       The Oracle connection on which the TAF callback was
       registered via <span class="function"><a href="function.oci-register-taf-callback.html" class="function">oci_register_taf_callback()</a></span>.
       The connection is not valid until the
       failover completes successfully.
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">event</code></dt>

     <dd>

      <p class="para">
       The failover event indicates the current status of
       the failover.
      </p>
      <p class="para">
       </p><ul class="itemizedlist">
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_BEGIN</code></strong> indicates that
          failover has detected a lost connection and failover
          is starting.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_END</code></strong> indicates successful
          completion of failover.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_ABORT</code></strong> indicates that
          failover was unsuccessful, and there is no option
          of retrying.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_ERROR</code></strong> also indicates
          that failover was unsuccessful, but it gives the
          application the opportunity to handle the error
          and return OCI_FO_RETRY to retry failover.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
           <strong><code>OCI_FO_REAUTH</code></strong> indicates
           that an Oracle user has been re-authenticated.
         </p>
        </li>
       </ul>
      <p></p>
     </dd>

    
    
     <dt>
<code class="parameter">type</code></dt>

     <dd>

      <p class="para">
       The failover type. This lets the callback know what
       type of failover the application has requested. The
       usual values are as follows:
      </p>
      <p class="para">
       </p><ul class="itemizedlist">
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_SESSION</code></strong> indicates that
          the user has requested only session failover. For
          example, if a user's connection is lost, then a
          new session is automatically created for the user
          on the backup. This type of failover does not
          attempt to recover SELECTs.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_SELECT</code></strong> indicates that
          the user has requested SELECT failover as well.
          It allows users with open cursors to continue
          fetching from them after failure.
         </p>
        </li>
       </ul>
      <p></p>
     </dd>

    
    
     <dt>
<code class="parameter">return value</code></dt>

     <dd>

      <p class="para">
       </p><ul class="itemizedlist">
        <li class="listitem">
         <p class="para">
          <strong><code>0</code></strong> indicates the failover
          steps should continue normally.
         </p>
        </li>
        <li class="listitem">
         <p class="para">
          <strong><code>OCI_FO_RETRY</code></strong> indicates that
          the failover should be attempted again by Oracle.
          In case of an error while failing over to a new
          connection, TAF is able to retry the failover.
          Typically, the application code should sleep for
          a while before returning OCI_FO_RETRY.
         </p>
        </li>
       </ul>
      <p></p>
     </dd>

    
   </dl>

  <p></p>
  <div class="example" id="example-1728">
   <div class="example-contents"><p>
    The following example registers a TAF callback
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br><br></span><span style="color: #FF8000">//&nbsp;Define&nbsp;userspace&nbsp;callback<br></span><span style="color: #007700">class&nbsp;</span><span style="color: #0000BB">MyClass&nbsp;</span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;</span><span style="color: #0000BB">$retry_count</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;function&nbsp;</span><span style="color: #0000BB">TAFCallback</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$type</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch&nbsp;(</span><span style="color: #0000BB">$event</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">OCI_FO_BEGIN</span><span style="color: #007700">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failing&nbsp;Over&nbsp;...&nbsp;Please&nbsp;stand&nbsp;by\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failover&nbsp;type&nbsp;was&nbsp;found&nbsp;to&nbsp;be&nbsp;%s&nbsp;\n"</span><span style="color: #007700">,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((</span><span style="color: #0000BB">$type</span><span style="color: #007700">==</span><span style="color: #0000BB">OCI_FO_SESSION</span><span style="color: #007700">)&nbsp;?&nbsp;</span><span style="color: #DD0000">"SESSION"<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">:((</span><span style="color: #0000BB">$type</span><span style="color: #007700">==</span><span style="color: #0000BB">OCI_FO_SELECT</span><span style="color: #007700">)&nbsp;?&nbsp;</span><span style="color: #DD0000">"SELECT"&nbsp;</span><span style="color: #007700">:&nbsp;</span><span style="color: #DD0000">"UNKNOWN!"</span><span style="color: #007700">)));<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$retry_count&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">OCI_FO_ABORT</span><span style="color: #007700">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;The&nbsp;application&nbsp;cannot&nbsp;continue&nbsp;using&nbsp;the&nbsp;database<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failover&nbsp;aborted.&nbsp;Failover&nbsp;will&nbsp;not&nbsp;take&nbsp;place.\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">OCI_FO_END</span><span style="color: #007700">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Failover&nbsp;completes&nbsp;successfully.&nbsp;Inform&nbsp;users&nbsp;a&nbsp;failover&nbsp;occurs.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failover&nbsp;ended&nbsp;...&nbsp;resuming&nbsp;services\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">OCI_FO_REAUTH</span><span style="color: #007700">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failed&nbsp;over&nbsp;user&nbsp;...&nbsp;resuming&nbsp;services\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Replay&nbsp;any&nbsp;ALTER&nbsp;SESSION&nbsp;commands&nbsp;associated&nbsp;with&nbsp;this&nbsp;connection<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;eg.&nbsp;oci_parse($conn,&nbsp;‘ALTER&nbsp;SESSION&nbsp;…’)&nbsp;;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">OCI_FO_ERROR</span><span style="color: #007700">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Stop&nbsp;retrying&nbsp;if&nbsp;we&nbsp;have&nbsp;already&nbsp;attempted&nbsp;for&nbsp;20&nbsp;times.<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$retry_count&nbsp;</span><span style="color: #007700">&gt;=&nbsp;</span><span style="color: #0000BB">20</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"&nbsp;Failover&nbsp;error&nbsp;received.&nbsp;Sleeping...\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">sleep</span><span style="color: #007700">(</span><span style="color: #0000BB">10</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">self</span><span style="color: #007700">::</span><span style="color: #0000BB">$retry_count</span><span style="color: #007700">++;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">OCI_FO_RETRY</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;retry&nbsp;failover<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;default:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Bad&nbsp;Failover&nbsp;Event:&nbsp;%d.\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$event</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></span><span style="color: #0000BB">$fn_name&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'MyClass::TAFCallback'</span><span style="color: #007700">;<br><br></span><span style="color: #0000BB">$conn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'hr'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'welcome'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'orcl'</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$sysconn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'system'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'oracle'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'orcl'</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">//&nbsp;Use&nbsp;a&nbsp;privileged&nbsp;connection&nbsp;to&nbsp;construct&nbsp;a&nbsp;SQL&nbsp;statement&nbsp;that&nbsp;will&nbsp;initiate&nbsp;failover<br></span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;&lt;&lt;&lt;&nbsp;'END'<br></span><span style="color: #DD0000">select&nbsp;unique&nbsp;'alter&nbsp;system&nbsp;disconnect&nbsp;session&nbsp;'''||sid||','||serial#||''''<br>from&nbsp;v$session_connect_info<br>where&nbsp;sid&nbsp;=&nbsp;sys_context('USERENV',&nbsp;'SID')<br></span><span style="color: #007700">END;<br><br></span><span style="color: #0000BB">$s&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_parse</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br></span><span style="color: #0000BB">oci_execute</span><span style="color: #007700">(</span><span style="color: #0000BB">$s</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$r&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_fetch_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$s</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$disconnectssql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$r</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br><br></span><span style="color: #0000BB">oci_register_taf_callback</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$fn_name</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;Register&nbsp;TAFCallback&nbsp;to&nbsp;Oracle&nbsp;TAF<br><br></span><span style="color: #007700">print(</span><span style="color: #DD0000">"Parsing&nbsp;user&nbsp;query\n"</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$sql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"select&nbsp;systimestamp&nbsp;from&nbsp;dual"</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$stmt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_parse</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sql</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">//&nbsp;For&nbsp;example,&nbsp;if&nbsp;a&nbsp;connection&nbsp;loss&nbsp;occurs&nbsp;at&nbsp;this&nbsp;point,&nbsp;oci_execute()&nbsp;will<br>//&nbsp;detect&nbsp;the&nbsp;loss&nbsp;and&nbsp;failover&nbsp;begins.&nbsp;During&nbsp;failover,&nbsp;oci_execute()&nbsp;will<br>//&nbsp;invoke&nbsp;the&nbsp;TAF&nbsp;callback&nbsp;function&nbsp;several&nbsp;times.&nbsp;If&nbsp;the&nbsp;failover&nbsp;is&nbsp;successful,<br>//&nbsp;a&nbsp;new&nbsp;connection&nbsp;is&nbsp;transparently&nbsp;created&nbsp;and&nbsp;oci_execute()&nbsp;will&nbsp;continue&nbsp;as<br>//&nbsp;usual.&nbsp;The&nbsp;connection&nbsp;session&nbsp;settings&nbsp;can&nbsp;be&nbsp;reset&nbsp;in&nbsp;the&nbsp;TAF&nbsp;callback<br>//&nbsp;function.&nbsp;If&nbsp;the&nbsp;failover&nbsp;is&nbsp;aborted,&nbsp;oci_execute()&nbsp;will&nbsp;return&nbsp;an&nbsp;error<br>//&nbsp;because&nbsp;a&nbsp;valid&nbsp;connection&nbsp;is&nbsp;not&nbsp;available.<br><br>//&nbsp;Disconnect&nbsp;the&nbsp;user,&nbsp;which&nbsp;initiates&nbsp;failover<br></span><span style="color: #007700">print(</span><span style="color: #DD0000">"Disconnecting&nbsp;the&nbsp;user\n"</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$discsql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_parse</span><span style="color: #007700">(</span><span style="color: #0000BB">$sysconn</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$disconnectssql</span><span style="color: #007700">);<br></span><span style="color: #0000BB">oci_execute</span><span style="color: #007700">(</span><span style="color: #0000BB">$discsql</span><span style="color: #007700">);<br><br>print(</span><span style="color: #DD0000">"Executing&nbsp;user&nbsp;query\n"</span><span style="color: #007700">);<br></span><span style="color: #0000BB">$e&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_execute</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br>if&nbsp;(!</span><span style="color: #0000BB">$e</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$m&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">trigger_error</span><span style="color: #007700">(</span><span style="color: #DD0000">"Could&nbsp;not&nbsp;execute&nbsp;statement:&nbsp;"</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">[</span><span style="color: #DD0000">'message'</span><span style="color: #007700">],&nbsp;</span><span style="color: #0000BB">E_USER_ERROR</span><span style="color: #007700">);<br>}<br></span><span style="color: #0000BB">$row&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">oci_fetch_array</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br>print(</span><span style="color: #0000BB">$row</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">//&nbsp;do&nbsp;other&nbsp;SQL&nbsp;statements&nbsp;with&nbsp;the&nbsp;new&nbsp;connection,&nbsp;if&nbsp;it&nbsp;is&nbsp;valid<br>//&nbsp;$stmt&nbsp;=&nbsp;oci_parse($conn,&nbsp;&nbsp;.&nbsp;.&nbsp;.);<br><br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </div>

 <div class="section">
 <h2 class="title">See Also</h2>
 <ul class="simplelist">
  <li class="member"><span class="function"><a href="function.oci-register-taf-callback.html" class="function">oci_register_taf_callback()</a></span></li>
  <li class="member"><span class="function"><a href="function.oci-unregister-taf-callback.html" class="function">oci_unregister_taf_callback()</a></span></li>
 </ul>
</div>


</div>

<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div>
 <div class="note">There are no user contributed notes for this page.</div></section>    </section><!-- layout-content -->
        


  </div><!-- layout -->

  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from www.php.net/manual/en/oci8.taf.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 07:25:31 GMT -->

</body></html>