<html><!-- Mirrored from www.php.net/manual/en/class.sessionhandler.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 05:37:39 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>SessionHandler</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="https://www.php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="class.sessionhandler.html">
 <link rel="shorturl" href="https://www.php.net/sessionhandler">
 <link rel="alternate" href="https://www.php.net/sessionhandler" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="book.session.html">
 <link rel="prev" href="function.session-write-close.html">
 <link rel="next" href="sessionhandler.close.html">

 <link rel="alternate" href="class.sessionhandler.html" hreflang="en">
 <link rel="alternate" href="https://www.php.net/manual/pt_BR/class.sessionhandler.php" hreflang="pt_BR">
 <link rel="alternate" href="https://www.php.net/manual/zh/class.sessionhandler.php" hreflang="zh">
 <link rel="alternate" href="https://www.php.net/manual/fr/class.sessionhandler.php" hreflang="fr">
 <link rel="alternate" href="https://www.php.net/manual/de/class.sessionhandler.php" hreflang="de">
 <link rel="alternate" href="https://www.php.net/manual/ja/class.sessionhandler.php" hreflang="ja">
 <link rel="alternate" href="https://www.php.net/manual/ro/class.sessionhandler.php" hreflang="ro">
 <link rel="alternate" href="https://www.php.net/manual/ru/class.sessionhandler.php" hreflang="ru">
 <link rel="alternate" href="https://www.php.net/manual/es/class.sessionhandler.php" hreflang="es">
 <link rel="alternate" href="https://www.php.net/manual/tr/class.sessionhandler.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached0aba.css?t=1539771603&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached2ecf.css?t=1539765004&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedba57.css?t=1606338002&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached3afa.css?t=1627831203&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script>
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="https://www.php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script src="https://www.php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>


</head>
<body class="docs " style="">


<div class="headsup"><a href="https://www.php.net/conferences/index.php#id2021-09-08-1">Longhorn PHP 2021</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.errors.html">Errors</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.attributes.html">Attributes</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.sessions.html">Session Security</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
	<dd><a href="refs.ui.html">GUI Extensions</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
    <div id="breadcrumbs-inner">
          
              
          <ul>
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.basic.session.html">Session Extensions</a></li>      <li><a href="book.session.html">Sessions</a></li>      </ul>
    </div>
  </div>




<div id="layout" class="clearfix">
  <section id="layout-content">
  <div id="class.sessionhandler" class="reference">

 <h1 class="title">The SessionHandler class</h1>
 

 <div class="partintro"><p class="verinfo">(PHP 5 &gt;= 5.4.0, PHP 7, PHP 8)</p>


  <div class="section" id="sessionhandler.intro">
   <h2 class="title">Introduction</h2>
   <p class="para">
    <span class="classname"><strong class="classname">SessionHandler</strong></span> is a special class that can be used
    to expose the current internal PHP session save handler by inheritance.
    There are seven methods which wrap the seven internal session save handler
    callbacks (<code class="parameter">open</code>, <code class="parameter">close</code>,
    <code class="parameter">read</code>, <code class="parameter">write</code>,
    <code class="parameter">destroy</code>, <code class="parameter">gc</code> and
    <code class="parameter">create_sid</code>).  By default, this class will wrap
    whatever internal save handler is set as defined by the
    <a href="session.configuration.html#ini.session.save-handler" class="link">session.save_handler</a>
    configuration directive which is usually <code class="parameter">files</code> by
    default.  Other internal session save handlers are provided by PHP
    extensions such as SQLite (as <code class="parameter">sqlite</code>), Memcache (as
    <code class="parameter">memcache</code>), and Memcached (as
    <code class="parameter">memcached</code>).
   </p>
   <p class="para">
    When a plain instance of <span class="classname"><strong class="classname">SessionHandler</strong></span> is set as the save handler using
    <span class="function"><a href="function.session-set-save-handler.html" class="function">session_set_save_handler()</a></span> it will wrap the current save handlers.
    A class extending from <span class="classname"><strong class="classname">SessionHandler</strong></span> allows you to override
    the methods or intercept or filter them by calls the parent class methods which ultimately wrap
    the internal PHP session handlers.
   </p>
   <p class="para">
    This allows you, for example, to intercept the <code class="parameter">read</code> and <code class="parameter">write</code>
    methods to encrypt/decrypt the session data and then pass the result to and from the parent class.
    Alternatively one might chose to entirely override a method like the garbage collection callback
    <code class="parameter">gc</code>.
   </p>
   <p class="para">
    Because the <span class="classname"><strong class="classname">SessionHandler</strong></span> wraps the current internal save handler
    methods, the above example of encryption can be applied to any internal save handler without
    having to know the internals of the handlers.
   </p>
   <p class="para">
    To use this class, first set the save handler you wish to expose using
    <a href="session.configuration.html#ini.session.save-handler" class="link">session.save_handler</a> and then pass an instance of
    <span class="classname"><strong class="classname">SessionHandler</strong></span> or one extending it to <span class="function"><a href="function.session-set-save-handler.html" class="function">session_set_save_handler()</a></span>.
   </p>
   <p class="para">
    Please note the callback methods of this class are designed to be called internally by
    PHP and are not meant to be called from user-space code.  The return values are equally processed internally
    by PHP.  For more information on the session workflow, please refer <span class="function"><a href="function.session-set-save-handler.html" class="function">session_set_save_handler()</a></span>.
   </p>
  </div>


  <div class="section" id="sessionhandler.synopsis">
   <h2 class="title">Class synopsis</h2>


   <div class="classsynopsis">
    <div class="ooclass"></div>


    <div class="classsynopsisinfo">
     <span class="ooclass">
      <span class="modifier">class</span> <strong class="classname">SessionHandler</strong>
     </span>

     <span class="oointerface"><span class="modifier">implements</span>  <a href="class.sessionhandlerinterface.html" class="interfacename">SessionHandlerInterface</a></span><span class="oointerface">,  <a href="class.sessionidinterface.html" class="interfacename">SessionIdInterface</a></span> {</div>


    <div class="classsynopsisinfo classsynopsisinfo_comment">/* Methods */</div>
    <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.close.html" class="methodname">close</a></span>(): <span class="type">bool</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.create-sid.html" class="methodname">create_sid</a></span>(): <span class="type">string</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.destroy.html" class="methodname">destroy</a></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$id</code></span>): <span class="type">bool</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.gc.html" class="methodname">gc</a></span>(<span class="methodparam"><span class="type">int</span> <code class="parameter">$max_lifetime</code></span>): <span class="type"><span class="type">int</span>|<span class="type">bool</span></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.open.html" class="methodname">open</a></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$path</code></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$name</code></span>): <span class="type">bool</span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.read.html" class="methodname">read</a></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$id</code></span>): <span class="type"><span class="type">string</span>|<span class="type"><span class="type false">false</span></span></span></div>
<div class="methodsynopsis dc-description"><span class="modifier">public</span> <span class="methodname"><a href="sessionhandler.write.html" class="methodname">write</a></span>(<span class="methodparam"><span class="type">string</span> <code class="parameter">$id</code></span>, <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>): <span class="type">bool</span></div>

   }</div>


  </div>

  <div class="section" id="session.notes">
   <div class="warning"><strong class="warning">Warning</strong>
    <p class="para">
     This class is designed to expose the current internal PHP session save handler, if you want to
     write your own custom save handlers, please implement the <span class="classname"><a href="class.sessionhandlerinterface.html" class="classname">SessionHandlerInterface</a></span>
     interface instead of extending from <span class="classname"><strong class="classname">SessionHandler</strong></span>.
    </p>
   </div>
  </div>

  <div class="section" id="sessionhandler.examples">
   <div class="example" id="example-4690">
    <p><strong>Example #1 
     Using <span class="classname"><strong class="classname">SessionHandler</strong></span> to add encryption to internal PHP save handlers.
    </strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br><br>&nbsp;</span><span style="color: #FF8000">/**<br>&nbsp;&nbsp;*&nbsp;decrypt&nbsp;AES&nbsp;256<br>&nbsp;&nbsp;*<br>&nbsp;&nbsp;*&nbsp;@param&nbsp;data&nbsp;$edata<br>&nbsp;&nbsp;*&nbsp;@param&nbsp;string&nbsp;$password<br>&nbsp;&nbsp;*&nbsp;@return&nbsp;decrypted&nbsp;data<br>&nbsp;&nbsp;*/<br></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">decrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$edata</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$password</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">base64_decode</span><span style="color: #007700">(</span><span style="color: #0000BB">$edata</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$salt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">16</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ct&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">16</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$rounds&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">3</span><span style="color: #007700">;&nbsp;</span><span style="color: #FF8000">//&nbsp;depends&nbsp;on&nbsp;key&nbsp;length<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data00&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$password</span><span style="color: #007700">.</span><span style="color: #0000BB">$salt</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$hash&nbsp;</span><span style="color: #007700">=&nbsp;array();<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$hash</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data00</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$hash</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">$rounds</span><span style="color: #007700">;&nbsp;</span><span style="color: #0000BB">$i</span><span style="color: #007700">++)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$hash</span><span style="color: #007700">[</span><span style="color: #0000BB">$i</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$hash</span><span style="color: #007700">[</span><span style="color: #0000BB">$i&nbsp;</span><span style="color: #007700">-&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">].</span><span style="color: #0000BB">$data00</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">$hash</span><span style="color: #007700">[</span><span style="color: #0000BB">$i</span><span style="color: #007700">];<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">32</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$iv&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$result</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">32</span><span style="color: #007700">,</span><span style="color: #0000BB">16</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">openssl_decrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$ct</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'AES-256-CBC'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br>&nbsp;&nbsp;}<br><br></span><span style="color: #FF8000">/**<br>&nbsp;*&nbsp;crypt&nbsp;AES&nbsp;256<br>&nbsp;*<br>&nbsp;*&nbsp;@param&nbsp;data&nbsp;$data<br>&nbsp;*&nbsp;@param&nbsp;string&nbsp;$password<br>&nbsp;*&nbsp;@return&nbsp;base64&nbsp;encrypted&nbsp;data<br>&nbsp;*/<br></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">encrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$password</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Set&nbsp;a&nbsp;random&nbsp;salt<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$salt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">openssl_random_pseudo_bytes</span><span style="color: #007700">(</span><span style="color: #0000BB">16</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$salted&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$dx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;Salt&nbsp;the&nbsp;key(32)&nbsp;and&nbsp;iv(16)&nbsp;=&nbsp;48<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">while&nbsp;(</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$salted</span><span style="color: #007700">)&nbsp;&lt;&nbsp;</span><span style="color: #0000BB">48</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$dx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">hash</span><span style="color: #007700">(</span><span style="color: #DD0000">'sha256'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$dx</span><span style="color: #007700">.</span><span style="color: #0000BB">$password</span><span style="color: #007700">.</span><span style="color: #0000BB">$salt</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$salted&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #0000BB">$dx</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$salted</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">32</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$iv&nbsp;&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">substr</span><span style="color: #007700">(</span><span style="color: #0000BB">$salted</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">32</span><span style="color: #007700">,</span><span style="color: #0000BB">16</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$encrypted_data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">openssl_encrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'AES-256-CBC'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$iv</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">base64_encode</span><span style="color: #007700">(</span><span style="color: #0000BB">$salt&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$encrypted_data</span><span style="color: #007700">);<br>}<br><br>class&nbsp;</span><span style="color: #0000BB">EncryptedSessionHandler&nbsp;</span><span style="color: #007700">extends&nbsp;</span><span style="color: #0000BB">SessionHandler<br></span><span style="color: #007700">{<br>&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br><br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">__construct</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!</span><span style="color: #0000BB">$data</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">decrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">key</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br><br>&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">)<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">encrypt</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$this</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">key</span><span style="color: #007700">);<br><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">parent</span><span style="color: #007700">::</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>}<br><br></span><span style="color: #FF8000">//&nbsp;we'll&nbsp;intercept&nbsp;the&nbsp;native&nbsp;'files'&nbsp;handler,&nbsp;but&nbsp;will&nbsp;equally&nbsp;work<br>//&nbsp;with&nbsp;other&nbsp;internal&nbsp;native&nbsp;handlers&nbsp;like&nbsp;'sqlite',&nbsp;'memcache'&nbsp;or&nbsp;'memcached'<br>//&nbsp;which&nbsp;are&nbsp;provided&nbsp;by&nbsp;PHP&nbsp;extensions.<br></span><span style="color: #0000BB">ini_set</span><span style="color: #007700">(</span><span style="color: #DD0000">'session.save_handler'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'files'</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'secret_string'</span><span style="color: #007700">;<br></span><span style="color: #0000BB">$handler&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">EncryptedSessionHandler</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">);<br></span><span style="color: #0000BB">session_set_save_handler</span><span style="color: #007700">(</span><span style="color: #0000BB">$handler</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br></span><span style="color: #0000BB">session_start</span><span style="color: #007700">();<br><br></span><span style="color: #FF8000">//&nbsp;proceed&nbsp;to&nbsp;set&nbsp;and&nbsp;retrieve&nbsp;values&nbsp;by&nbsp;key&nbsp;from&nbsp;$_SESSION</span>
</span>
</code></div>
    </div>

   </div>
   <blockquote class="note"><p><strong class="note">Note</strong>: 
    </p><p class="para">
     Since this class' methods are designed to be called internally by PHP as part of the normal session workflow,
     child class calls to parent methods (i.e. the actual internal native handlers) will return <strong><code>false</code></strong> unless
     the session has actually been started (either automatically, or by explicit <span class="function"><a href="function.session-start.html" class="function">session_start()</a></span>.
     This is important to consider when writing unit tests where the class methods might be invoked manually.
    </p>
   <p></p></blockquote>
  </div>

 </div>

 
 






 
































<h2>Table of Contents</h2><ul class="chunklist chunklist_reference"><li><a href="sessionhandler.close.html">SessionHandler::close</a> — Close the session</li><li><a href="sessionhandler.create-sid.html">SessionHandler::create_sid</a> — Return a new session ID</li><li><a href="sessionhandler.destroy.html">SessionHandler::destroy</a> — Destroy a session</li><li><a href="sessionhandler.gc.html">SessionHandler::gc</a> — Cleanup old sessions</li><li><a href="sessionhandler.open.html">SessionHandler::open</a> — Initialize session</li><li><a href="sessionhandler.read.html">SessionHandler::read</a> — Read session data</li><li><a href="sessionhandler.write.html">SessionHandler::write</a> — Write session data</li></ul>
</div>

<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="117756">  
  <a class="name">
  <strong class="user"><em>rasmus at mindplay dot dk</em></strong></a><div class="date" title="2015-08-03 09:08"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom117756">
<div class="phpcode"><code><span class="html">
As the life-cycle of a session handler is fairly complex, I found it difficult to understand when explained using just words - so I traced the function calls made to a custom SessionHandler, and created this overview of precisely what happens when you call various session methods:<br><br><a rel="nofollow" target="_blank">https://gist.github.com/mindplay-dk/623bdd50c1b4c0553cd3</a><br><br>I hope this makes it considerably easier to implement a custom SessionHandler and get it right the first time :-)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="124829">  
  <a class="name">
  <strong class="user"><em>saccani dot francesco dot NOSPAM at gmail dot com</em></strong></a><div class="date" title="2020-03-15 08:07"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom124829">
<div class="phpcode"><code><span class="html">
I made this gist to provide a complete overview of the PHP session handler life cycle updated to version 7.0 or above. In particular, I wanted to emphasize what methods and in what order are called when the native PHP functions are used for session management.<br><br><a rel="nofollow" target="_blank">https://gist.github.com/franksacco/d6e943c41189f8ee306c182bf8f07654</a><br><br>I hope this analysis will help all the developers interested in understanding in detail the native session management performed by PHP and what a custom session handler should do.<br>Any comment or suggestion is appreciated.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="122826">  
  <a class="name">
  <strong class="user"><em>tony at marston-home dot demon dot co dot uk</em></strong></a><div class="date" title="2018-06-12 07:55"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom122826">
<div class="phpcode"><code><span class="html">
Your custom session handler should not contain calls to any of the session functions, such as session_name() or session_id(), as the relevant values are passed as arguments on various handler methods. Attempting to obtain values from alternative sources may not work as expected.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="123892">  
  <a class="name">
  <strong class="user"><em>wei dot kavin at gmail dot com</em></strong></a><div class="date" title="2019-05-29 07:38"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom123892">
<div class="phpcode"><code><span class="html">
php -S localhost:8000 -t foo/<br><br>touch index.php<br><br>vi index.php<br>============================================================<br>class NativeSessionHandler extends \SessionHandler<br>{<br>&nbsp; &nbsp; public function __construct($savePath = null)<br>&nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; if (null === $savePath) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $savePath = ini_get('session.save_path');<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; $baseDir = $savePath;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; if ($count = substr_count($savePath, ';')) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($count &gt; 2) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new \InvalidArgumentException(sprintf('Invalid argument $savePath \'%s\'', $savePath));<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // characters after last ';' are the path<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $baseDir = ltrim(strrchr($savePath, ';'), ';');<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; if ($baseDir &amp;&amp; !is_dir($baseDir) &amp;&amp; !@mkdir($baseDir, 0777, true) &amp;&amp; !is_dir($baseDir)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; throw new \RuntimeException(sprintf('Session Storage was not able to create directory "%s"', $baseDir));<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; ini_set('session.save_path', $savePath);<br>&nbsp; &nbsp; &nbsp; &nbsp; ini_set('session.save_handler', 'files');<br>&nbsp; &nbsp; }<br>}<br><br>$handler = new NativeSessionHandler("/var/www/foo");<br>session_set_save_handler($handler, true);<br>session_start();<br>$a = $handler-&gt;write("aaa","bbbb");var_dump($a);exit;<br><br>============================================================<br><br>output：bool(false)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="118964">  
  <a class="name">
  <strong class="user"><em>jeremie dot legrand at komori-chambon dot fr</em></strong></a><div class="date" title="2016-03-09 09:22"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom118964">
<div class="phpcode"><code><span class="html">
Here is a wrapper to log in a file each session's operations. Useful to investigate sessions locks (which prevent PHP to serve simultaneous requests for a same client).<br>Just change the file name at the end to dump logs where you want. <br><br>class DumpSessionHandler extends SessionHandler {<br>&nbsp; &nbsp; private $fich;<br><br>&nbsp; &nbsp; public function __construct($fich) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;fich = $fich;<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function close() {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('close');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::close();<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function create_sid() {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('create_sid');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::create_sid();<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function destroy($session_id) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('destroy('.$session_id.')');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::destroy($session_id);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function gc($maxlifetime) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('close('.$maxlifetime.')');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::gc($maxlifetime);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function open($save_path, $session_name) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('open('.$save_path.', '.$session_name.')');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::open($save_path, $session_name);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function read($session_id) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('read('.$session_id.')');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::read($session_id);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function write($session_id, $session_data) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;log('write('.$session_id.', '.$session_data.')');<br>&nbsp; &nbsp; &nbsp; &nbsp; return parent::write($session_id, $session_data);<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; private function log($action) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $base_uri = explode('?', $_SERVER['REQUEST_URI'], 2)[0];<br>&nbsp; &nbsp; &nbsp; &nbsp; $hdl = fopen($this-&gt;fich, 'a');<br>&nbsp; &nbsp; &nbsp; &nbsp; fwrite($hdl, date('Y-m-d h:i:s').' '.$base_uri.' : '.$action."\n");<br>&nbsp; &nbsp; &nbsp; &nbsp; fclose($hdl);<br>&nbsp; &nbsp; }<br>}<br>ini_set('session.save_handler', 'files');<br>$handler = new DumpSessionHandler('/path/to/dump_sessions.log');<br>session_set_save_handler($handler, true);</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->

  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from www.php.net/manual/en/class.sessionhandler.php by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 11 Sep 2021 05:37:39 GMT -->

</body></html>